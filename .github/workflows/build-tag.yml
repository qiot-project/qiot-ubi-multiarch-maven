name: Release

on:
  push:
    tags:
      - '*'
  
  workflow_dispatch:

jobs:
  create_and_publish_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
              
      - name: Load environment variables from .env files 
        uses: c-py/action-dotenv-to-setenv@v3
        with:
          env-file: variables.env

      - name: Get the version
        id: get_version
        run: echo "::set-output name=VERSION::${GITHUB_REF##refs/tags/v}"

      - name: Build the Docker image - Java 11
        run: |
            docker run --rm --privileged multiarch/qemu-user-static:register --reset
            docker build --build-arg BASE_MULTIARCH_VERSION=${BASE_MULTIARCH_VERSION} --build-arg ARCH=${ARCH} --build-arg JAVA_VERSION=11 -t "${DOCKER_CONTAINER}:${{ steps.get_version.outputs.VERSION }}-java11" --platform ${DOCKER_ARCH} --pull -f Dockerfile.multiarch-aarch64 .
            docker tag $DOCKER_CONTAINER:$PROJECT_VERSION $DOCKER_CONTAINER:latest-java11
      - name: Push To Quay - Java 11
        id: push-to-quay-java11
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ env.DOCKER_CONTAINER }}
          tags: ${{ steps.get_version.outputs.VERSION }}-java11 latest-java11
          registry: ${{ env.DOCKER_REPO }}
          username: ${{ secrets.QUAY_ALL_USERNAME }}
          password: ${{ secrets.QUAY_ALL_PASSWORD }}

      - name: Build the Docker image - Java 17
        run: |
            docker run --rm --privileged multiarch/qemu-user-static:register --reset
            docker build --build-arg BASE_MULTIARCH_VERSION=${BASE_MULTIARCH_VERSION} --build-arg ARCH=${ARCH} --build-arg JAVA_VERSION=17 -t "${DOCKER_CONTAINER}:${{ steps.get_version.outputs.VERSION }}-java17" --platform ${DOCKER_ARCH} --pull -f Dockerfile.multiarch-aarch64 .
            docker tag $DOCKER_CONTAINER:$PROJECT_VERSION $DOCKER_CONTAINER:latest-java17
      - name: Push To Quay - Java 17
        id: push-to-quay-java17
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ env.DOCKER_CONTAINER }}
          tags: ${{ steps.get_version.outputs.VERSION }}-java17 latest-java17
          registry: ${{ env.DOCKER_REPO }}
          username: ${{ secrets.QUAY_ALL_USERNAME }}
          password: ${{ secrets.QUAY_ALL_PASSWORD }}
